name: Android Fix (Version 17)

on: [push, workflow_dispatch]

jobs:
  fix-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Global Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # ðŸ› ï¸ STEP: FORCE UPDATE TO JAVA 17 (The Fix)
      # Ye command pure project me 'Java 1.8' ko dhund kar 'Java 17' kar dega.
      # Chahe wo Groovy ho (.gradle) ya Kotlin DSL (.kts).
      # ========================================================
      - name: ðŸ”§ Upgrade Java Version to 17
        run: |
          echo "ðŸ”„ Updating Java Compatibility to 17..."
          
          # Strategy: 'find' command se sari gradle files dhundo aur 'sed' se replace karo
          
          # 1. Replace 'JavaVersion.VERSION_1_8' with 'JavaVersion.VERSION_17'
          find . -type f -name "*build.gradle*" -exec sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_17/g' {} +
          
          # 2. Replace string "1.8" with "17" (Common in KotlinOptions)
          find . -type f -name "*build.gradle*" -exec sed -i 's/"1.8"/"17"/g' {} +
          find . -type f -name "*build.gradle*" -exec sed -i "s/'1.8'/'17'/g" {} +
          
          echo "âœ… Code updated to target Java 17."

      # Pichla fix bhi zaruri hai (AndroidX & Memory)
      - name: ðŸ”§ Inject System Properties
        run: |
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=1g" >> gradle.properties

      # BUILD COMMAND
      - name: ðŸ—ï¸ Build APK
        id: buildCmd
        run: |
          echo "ðŸš€ Building with unified Java 17..."
          set -o pipefail
          
          # Ab build clean hona chahiye
          gradle assembleDebug --no-daemon --stacktrace --console=plain 2>&1 | tee build.log

      # ERROR TRAP (Agar ab bhi kuch phata to)
      - name: ðŸš¨ Show Me The Error
        if: failure()
        run: |
          echo "::error::ðŸ›‘ BUILD FAILED! Analysis:"
          if [ -f "build.log" ]; then
             grep -C 5 -E "e: |ERROR|FAILED|Exception|Caused by:" build.log
          fi

      - name: ðŸ“¦ Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
