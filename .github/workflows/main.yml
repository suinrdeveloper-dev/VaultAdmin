name: üïµÔ∏è Universal Error Finder

on: [push, workflow_dispatch]

jobs:
  scan-code:
    name: üîç Scan All Files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1. Code Download
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Environment (Java 17 Fixed)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 3. Gradle Setup
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # 4. Permissions Fix
      - name: Fix Permissions
        run: chmod +x gradlew

      # ========================================================
      # üöÄ STEP 5: THE COMPILER RUN (No APK, Just Code Check)
      # Hum 'assembleDebug' nahi, balki 'compileDebugSources' chala rahe hain.
      # Ye bahut fast hota hai aur sirf SYNTAX ERROR dhundta hai.
      # ========================================================
      - name: üîç Run Code Analysis
        id: scanner
        run: |
          echo "üöÄ Scanning Project for Errors..."
          set -o pipefail
          
          # Hum output ko 'error_log.txt' me save karenge
          # --quiet: Faltu info hatata hai
          # --stacktrace: Error ki detail deta hai
          ./gradlew compileDebugSources compileDebugKotlin --no-daemon --stacktrace --console=plain > error_log.txt 2>&1 || true

      # ========================================================
      # üö® STEP 6: ERROR EXTRACTOR (Magic Step)
      # Ye step log file ko padhkar sundar tarike se error dikhayega
      # ========================================================
      - name: üõë SHOW ME THE ERRORS
        run: |
          echo "::group::üìÇ FULL LOGS (Click to Open)"
          cat error_log.txt
          echo "::endgroup::"

          echo ""
          echo "========================================================"
          echo "üö© ERROR REPORT (Sirf Kaam ki Baat)"
          echo "========================================================"

          # 1. KOTLIN/JAVA ERRORS (Syntax, Imports, Variables)
          # Pattern: "e: /path/to/File.kt: (Line, Col): Error Message"
          if grep -q "e: " error_log.txt; then
             echo "‚ùå CODE ERRORS FOUND:"
             # Ye command sirf 'e:' wali lines aur file names nikalegi
             grep -E "e: .*kt: |e: .*java: " error_log.txt
             echo "----------------------------------------"
             # Thoda aur detail (context)
             grep -A 2 "e: " error_log.txt
          else
             echo "‚úÖ No Kotlin/Java Syntax Errors found."
          fi

          echo ""
          echo "========================================================"

          # 2. XML/LAYOUT ERRORS (Resources, IDs)
          # Pattern: "Error: ... .xml"
          if grep -q ".xml" error_log.txt; then
             echo "‚ùå XML/LAYOUT ERRORS FOUND:"
             grep -E "Error:.*xml|Resource.*failed" error_log.txt
          else
             echo "‚úÖ No XML Layout Errors found."
          fi

          echo ""
          echo "========================================================"

          # 3. DEPENDENCY/GRADLE ERRORS
          if grep -q "Could not resolve" error_log.txt; then
             echo "‚ùå DEPENDENCY MISSING:"
             grep "Could not resolve" error_log.txt
          fi
          
          # 4. CHECK IF BUILD FAILED
          if grep -q "BUILD FAILED" error_log.txt; then
             echo "üî¥ STATUS: BUILD FAILED"
             echo "Asli wajah niche dekhein üëá"
             grep -A 5 "What went wrong:" error_log.txt || grep -A 10 "FAILURE:" error_log.txt
             exit 1
          else
             echo "üü¢ STATUS: ALL CLEAR! (Code Sahi Hai)"
          fi
