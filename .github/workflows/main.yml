name: üïµÔ∏è Smart Error Scanner (Auto-Detect)

on: [push, workflow_dispatch]

jobs:
  smart-scan:
    name: üîç Auto-Detect & Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1. Code Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Setup Global Gradle (Just in case wrapper is missing)
      - name: Setup Gradle Tool
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # üß† SMART EXECUTION STEP (The Fix)
      # Ye step khud faisla karega ki kaise run karna hai
      # ========================================================
      - name: üöÄ Locate & Scan Code
        id: scanner
        run: |
          echo "üîç Searching for build system..."
          set -o pipefail

          # Step A: gradlew file dhundo
          GRADLE_PATH=$(find . -name "gradlew" -type f | head -n 1)

          if [ -n "$GRADLE_PATH" ]; then
              echo "‚úÖ Wrapper FOUND at: $GRADLE_PATH"
              chmod +x "$GRADLE_PATH"
              
              # Wrapper use karke scan karo
              echo "üöÄ Running Scan using Wrapper..."
              "$GRADLE_PATH" compileDebugSources --no-daemon --stacktrace --console=plain > error_log.txt 2>&1 || true
          
          else
              echo "‚ö†Ô∏è Wrapper NOT FOUND. Switching to Global Gradle..."
              
              # Global Gradle use karke scan karo
              echo "üöÄ Running Scan using Global Gradle..."
              gradle compileDebugSources --no-daemon --stacktrace --console=plain > error_log.txt 2>&1 || true
          fi

      # ========================================================
      # üõë ERROR REPORTER (Result dikhane wala step)
      # ========================================================
      - name: üìã DISPLAY ERRORS
        run: |
          echo "::group::üìÇ RAW LOGS (Click to see full details)"
          cat error_log.txt
          echo "::endgroup::"

          echo ""
          echo "========================================================"
          echo "üö© FINAL DIAGNOSTIC REPORT"
          echo "========================================================"

          # 1. Check for KOTLIN Syntax Errors
          if grep -q "e: " error_log.txt; then
             echo "‚ùå CODE ERROR FOUND (File & Line):"
             # Sirf 'e:' wali lines nikalo jo file path dikhati hain
             grep -E "e: .*kt: " error_log.txt
             echo "----------------------------------------"
             echo "Details:"
             grep -A 1 "e: " error_log.txt | head -n 20
          
          # 2. Check for XML Layout Errors
          elif grep -q "Error:.*xml" error_log.txt; then
             echo "‚ùå XML LAYOUT ERROR FOUND:"
             grep -E "Error:.*xml" error_log.txt

          # 3. Check for Dependency Errors
          elif grep -q "Could not resolve" error_log.txt; then
             echo "‚ùå MISSING LIBRARY/DEPENDENCY:"
             grep "Could not resolve" error_log.txt | head -n 5

          # 4. Success Check
          elif grep -q "BUILD SUCCESSFUL" error_log.txt; then
             echo "üü¢ CONGRATULATIONS! NO SYNTAX ERRORS FOUND."
             echo "Aapka code compile hone ke liye taiyar hai."
          
          else
             echo "‚ö†Ô∏è UNKNOWN ERROR. Please check Raw Logs above."
             tail -n 20 error_log.txt
          fi
          echo "========================================================"

