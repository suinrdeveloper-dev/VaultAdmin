name: Android Debugger (Fix Path)

on: [push, workflow_dispatch]

jobs:
  debug-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # STEP 1: Sabse Pehle File Structure Dekho
      # Is step ka output check karna. Ye batayega gradlew kahan chupa hai.
      - name: ðŸ“‚ List All Files
        run: |
          echo "Current Directory: $(pwd)"
          echo "Files in Root:"
          ls -la
          echo "======================="
          echo "Searching for gradlew..."
          find . -name "gradlew"
          echo "======================="

      # STEP 2: JDK Setup
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # STEP 3: Smart Execution (Automatic Discovery)
      # Ye script khud dhundega ki gradlew kahan hai aur wahin se run karega.
      - name: Build with Auto-Discovery
        id: buildCmd
        run: |
          # Gradlew file dhundo
          GRADLE_PATH=$(find . -name "gradlew" | head -n 1)

          if [ -z "$GRADLE_PATH" ]; then
            echo "::error::âŒ CRITICAL: 'gradlew' file pure project me kahin nahi mili! Shayad wo commit nahi hui hai."
            exit 1
          fi

          echo "âœ… Found gradlew at: $GRADLE_PATH"
          
          # Uss folder me jao jahan gradlew hai
          PROJECT_ROOT=$(dirname "$GRADLE_PATH")
          cd "$PROJECT_ROOT"
          
          echo "ðŸ“‚ Changed directory to: $(pwd)"
          
          # Permissions do
          chmod +x gradlew
          
          # Build chalao (Output capture ke sath)
          set -o pipefail
          ./gradlew assembleDebug --no-daemon --stacktrace --console=plain 2>&1 | tee ../build.log
          # Note: '../build.log' isliye kiya taki log file root me save ho

      # STEP 4: Error Trap
      - name: ðŸš¨ Show Me The Error
        if: failure()
        run: |
          echo "::error::ðŸ›‘ BUILD FAILED! Checking Logs..."
          # Ab log file check karo (agar bani hai)
          if [ -f "build.log" ]; then
             grep -C 5 -E "e: |ERROR|FAILED|Exception|Caused by:" build.log
          else
             echo "Build log file nahi mili. Shayad build start hone se pehle hi crash ho gaya."
          fi
