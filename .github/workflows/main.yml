name: Android Build (Auto-Fix Mode)

on: [push, workflow_dispatch]

jobs:
  build-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Global Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # ðŸ› ï¸ STEP 4: AUTO-FIX GRADLE PROPERTIES (MAGIC STEP)
      # Ye step 'gradle.properties' file create karega aur
      # AndroidX enable karega taki build crash na ho.
      # ========================================================
      - name: ðŸ”§ Inject AndroidX Properties
        run: |
          echo "Injecting AndroidX settings..."
          
          # Ye file create/append karega
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          
          # Ye wo warning hatayega jo logs me dikh raha tha (compileSdk 34)
          echo "android.suppressUnsupportedCompileSdk=34" >> gradle.properties
          
          echo "âœ… gradle.properties updated:"
          cat gradle.properties

      - name: Build Debug APK
        id: buildCmd
        run: |
          echo "ðŸš€ Starting build..."
          set -o pipefail
          
          # Direct Gradle use kar rahe hain
          gradle assembleDebug --no-daemon --stacktrace --console=plain 2>&1 | tee build.log

      - name: ðŸš¨ Show Me The Error
        if: failure()
        run: |
          echo "::error::ðŸ›‘ BUILD FAILED! Log Analysis:"
          echo "=================================================="
          if [ -f "build.log" ]; then
             grep -C 5 -E "e: |ERROR|FAILED|Exception|Caused by:|Unresolved reference" build.log
          fi
          echo "=================================================="

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
