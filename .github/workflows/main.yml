name: Android Full Diagnostic

on: [push, workflow_dispatch]

jobs:
  debug-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Global Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # STEP 1: FIX MEMORY & PROPERTIES (CRITICAL)
      # Hum RAM badha rahe hain (3GB) taki build crash na ho.
      # ========================================================
      - name: ðŸ”§ Tune System Performance
        run: |
          echo "Setting up optimized environment..."
          
          # Fix AndroidX config
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          
          # Fix Memory (JVM Args) - Ye crash rokega
          echo "org.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=1g" >> gradle.properties
          
          # Print properties to check
          echo "âœ… gradle.properties content:"
          cat gradle.properties

      # ========================================================
      # STEP 2: BUILD & CAPTURE FULL LOGS
      # Hum 'grep' nahi use karenge. Pura log file me save karenge.
      # ========================================================
      - name: ðŸ—ï¸ Run Build (Capture All Logs)
        id: buildCmd
        run: |
          echo "ðŸš€ Starting Full Build..."
          set -o pipefail
          
          # Hum '--scan' use kar rahe hain jo web link dega
          # Hum output ko 'build_output.txt' me bhej rahe hain
          gradle assembleDebug --no-daemon --stacktrace --scan 2>&1 | tee build_output.txt
        continue-on-error: true # Fail hone par bhi agla step chalega (taki log mile)

      # ========================================================
      # STEP 3: UPLOAD LOG FILE (MOST IMPORTANT)
      # Build fail ho ya pass, ye file tumhe download karne ko milegi.
      # ========================================================
      - name: ðŸ“‚ Upload Full Log File
        uses: actions/upload-artifact@v4
        with:
          name: Full-Build-Log
          path: build_output.txt
          retention-days: 1

      # ========================================================
      # STEP 4: UPLOAD APK (Agar ban gaya toh)
      # ========================================================
      - name: ðŸ“¦ Upload APK (If Success)
        if: steps.buildCmd.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
