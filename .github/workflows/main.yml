name: Android Auto-Upgrade (Fix All)

on: [push, workflow_dispatch]

jobs:
  fix-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # üõ†Ô∏è STEP 1: FORCE SDK UPGRADE (SDK 33 -> 34)
      # Ye sabse important fix hai. Hum purane SDK version ko
      # hatakar zabardasti '34' likh denge.
      # ========================================================
      - name: üîß Force Upgrade SDK & Java
        run: |
          echo "üîÑ Upgrading Project Configuration..."

          # 1. Update SDK Versions (compileSdk 34)
          # Ye command 'compileSdk 33' (ya koi bhi number) ko 'compileSdk 34' bana dega
          find . -name "build.gradle*" -exec sed -i -E 's/compileSdk[[:space:]]*[0-9]+/compileSdk 34/g' {} +
          find . -name "build.gradle*" -exec sed -i -E 's/compileSdkVersion[[:space:]]*[0-9]+/compileSdkVersion 34/g' {} +
          
          # 2. Update Target SDK (targetSdk 34)
          find . -name "build.gradle*" -exec sed -i -E 's/targetSdk[[:space:]]*[0-9]+/targetSdk 34/g' {} +
          find . -name "build.gradle*" -exec sed -i -E 's/targetSdkVersion[[:space:]]*[0-9]+/targetSdkVersion 34/g' {} +

          # 3. Update Java Version (Java 1.8 -> 17)
          find . -name "build.gradle*" -exec sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_17/g' {} +
          find . -name "build.gradle*" -exec sed -i "s/'1.8'/'17'/g" {} +
          find . -name "build.gradle*" -exec sed -i 's/"1.8"/"17"/g' {} +

          echo "‚úÖ Project files updated to SDK 34 & Java 17."

      # ========================================================
      # üõ†Ô∏è STEP 2: INJECT PROPERTIES (AndroidX & Memory)
      # ========================================================
      - name: üîß Inject System Properties
        run: |
          # AndroidX Enable karo
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          
          # Warning Hatao (Kyunki hum zabardasti 34 use kar rahe hain)
          echo "android.suppressUnsupportedCompileSdk=34" >> gradle.properties
          
          # Memory Badhao (Crash rokne ke liye)
          echo "org.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=1g" >> gradle.properties

      # ========================================================
      # üèóÔ∏è BUILD COMMAND
      # ========================================================
      - name: üöÄ Build Debug APK
        id: buildCmd
        run: |
          echo "Starting Build..."
          set -o pipefail
          # '--scan' link dega, 'tee' log save karega
          gradle assembleDebug --no-daemon --scan --stacktrace 2>&1 | tee build.log
        continue-on-error: true

      # ========================================================
      # üö® ERROR TRAP (Improved)
      # Ab hum specifically 'Metadata' error dhundenge
      # ========================================================
      - name: üîç Check Specific Errors
        if: steps.buildCmd.outcome == 'failure'
        run: |
          echo "::error::üõë BUILD FAIL! Checking Logs..."
          echo "=========================================================="
          
          # 1. Check for Metadata/Version Issue (Jo abhi aaya tha)
          if grep -q "checkDebugAarMetadata" build.log; then
             echo "::error::‚ö†Ô∏è SDK Version Mismatch Detected!"
             grep -C 10 "checkDebugAarMetadata" build.log
             grep -C 5 "dependency's AAR metadata" build.log || echo ""
          fi

          # 2. Check for Kotlin Code Errors
          grep -E "e: .*kt: \(" build.log || echo "No Kotlin Syntax Errors."
          
          # 3. Check for Generic Failure
          grep -C 5 "FAILURE: Build failed" build.log

          echo "=========================================================="
          exit 1

      - name: üì¶ Upload APK (Success Only)
        if: steps.buildCmd.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
