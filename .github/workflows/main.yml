name: Android "God Mode" Build

on: [push, workflow_dispatch]

jobs:
  override-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # üõ†Ô∏è STEP: CREATE GOD MODE SCRIPT (init.gradle)
      # Ye script build process ko hijack karke Java 17 force karegi.
      # Chahe file me kuch bhi likha ho, ye usko overwrite kar dega.
      # ========================================================
      - name: üìù Create Init Script
        run: |
          cat <<EOF > init.gradle
          allprojects {
              afterEvaluate { project ->
                  // 1. Force Android Compile Options to Java 17
                  if (project.hasProperty("android")) {
                      project.android {
                          compileOptions {
                              sourceCompatibility = JavaVersion.VERSION_17
                              targetCompatibility = JavaVersion.VERSION_17
                          }
                      }
                  }
                  // 2. Force Kotlin Options to Java 17
                  project.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                      kotlinOptions {
                          jvmTarget = "17"
                      }
                  }
              }
          }
          EOF
          
          echo "‚úÖ Init script created. Java 17 will be enforced."

      # ========================================================
      # üîß PROPERTIES INJECTION (AndroidX & Memory)
      # ========================================================
      - name: üîß Inject System Properties
        run: |
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=1g" >> gradle.properties
          # SDK Version warning suppression
          echo "android.suppressUnsupportedCompileSdk=34" >> gradle.properties

      # ========================================================
      # üèóÔ∏è BUILD COMMAND (With Injection)
      # Notice the '-I init.gradle'. This activates the override.
      # ========================================================
      - name: üöÄ Build Debug APK
        id: buildCmd
        run: |
          echo "üöÄ Starting God Mode Build..."
          set -o pipefail
          
          # '-I init.gradle' sabse zaroori hai yahan
          gradle assembleDebug --no-daemon --stacktrace -I init.gradle 2>&1 | tee build.log

      # ========================================================
      # üö® ERROR TRAP (Precision Mode)
      # ========================================================
      - name: üîç Diagnose Failure
        if: failure()
        run: |
          echo "::error::üõë BUILD FAIL! Checking Logs..."
          echo "=========================================================="
          
          # 1. Check for Java Mismatch (Should be gone now)
          grep -C 2 "jvm target compatibility" build.log || echo "‚úÖ Java Version Mismatch Fixed."

          # 2. Check for Kotlin Code Errors (Asli Galti)
          if grep -q "e: file://" build.log; then
              echo "::error::found CODE ERROR!"
              grep -E "e: file://.*kt:" build.log
          elif grep -q "e: " build.log; then
               # Simple format
               grep -E "e: .*kt: \(" build.log
          fi
          
          # 3. Check for Generic Failure
          grep -C 5 "FAILURE: Build failed" build.log
          echo "=========================================================="

      - name: üì¶ Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk

