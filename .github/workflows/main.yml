name: Android Build (Emergency Mode)

on: [push, workflow_dispatch]

jobs:
  build-no-wrapper:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # 1. Code Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Java Setup
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle Setup (CRITICAL STEP)
      # Hum yahan 'gradle' tool setup kar rahe hain, wrapper nahi.
      # Version '8.2' set kiya hai taaki compatibility bani rahe.
      - name: Setup Global Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # 4. Build Command (Direct Gradle)
      # Notice karo: Humne './gradlew' ko hata kar sirf 'gradle' likha hai.
      # Ye command server ke tool ko use karega, file ko nahi.
      - name: Build Debug APK
        id: buildCmd
        run: |
          echo "ðŸš€ Starting build using Global Gradle..."
          set -o pipefail
          
          # Command change: './gradlew' -> 'gradle'
          gradle assembleDebug --no-daemon --stacktrace --console=plain 2>&1 | tee build.log

      # 5. Smart Error Trap (Wahi purana logic, jo ab kaam karega)
      - name: ðŸš¨ Show Me The Error
        if: failure()
        run: |
          echo "::error::ðŸ›‘ BUILD FAILED! Log Analysis:"
          echo "=================================================="
          
          if [ -f "build.log" ]; then
             # Ab hum specific errors dhundenge jo code se related hon
             grep -C 5 -E "e: |ERROR|FAILED|Exception|Caused by:|Unresolved reference" build.log
          else
             echo "Log file nahi mili. System crash hua hai."
          fi
          echo "=================================================="

      # 6. Artifact Upload
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
