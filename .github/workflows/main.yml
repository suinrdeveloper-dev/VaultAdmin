name: Android Spy Build (Debug Mode)

on: [push, workflow_dispatch]

jobs:
  debug-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle Setup with Build Scan Auto-Accept
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      # üõ†Ô∏è Fix Java Version & Memory (Zabardasti 17 set karna)
      - name: üîß Force Java 17 & Fix Memory
        run: |
          # Memory Badhao
          echo "org.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=1g" >> gradle.properties
          
          # Java 17 Force karo (Files replace karke)
          find . -type f -name "*build.gradle*" -exec sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_17/g' {} +
          find . -type f -name "*build.gradle*" -exec sed -i "s/'1.8'/'17'/g" {} +
          
          echo "‚úÖ Config updated."

      # üèóÔ∏è Build Command
      - name: üöÄ Build Debug APK
        id: buildCmd
        run: |
          set -o pipefail
          echo "Starting Build..."
          # Log file save kar rahe hain
          gradle assembleDebug --no-daemon --scan --stacktrace 2>&1 | tee build.log
        continue-on-error: true # Fail hone par bhi agla step chalega

      # üïµÔ∏è JASOOS STEP (Sirf Error Dhundega)
      - name: üîç Kahan Hai Error?
        if: steps.buildCmd.outcome == 'failure'
        run: |
          echo "::error::üõë BUILD FAIL HUA HAI! Niche dekho galti kahan hai:"
          echo "=========================================================="
          
          # 1. Sirf FILE NAMES aur ERROR lines dhundo
          # Ye command log me se wo line nikalegi jo 'e:' se shuru hoti hai (Kotlin Errors)
          grep -E "e: .*kt: \(" build.log || echo "Kotlin Syntax Error nahi mila."
          
          echo "----------------------------------------------------------"
          
          # 2. Agar XML error hai (Layout files)
          grep -E "Error:.*xml" build.log || echo "XML Error nahi mila."
          
          echo "----------------------------------------------------------"
          
          # 3. Agar Generic Error hai
          grep -C 2 "FAILED" build.log
          
          echo "=========================================================="
          exit 1 # GitHub ko batao ki fail hua hai

      - name: üì¶ Upload APK (Success Only)
        if: steps.buildCmd.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
