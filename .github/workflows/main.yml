name: Android Builder (Auto-Config)

on: [push, workflow_dispatch]

jobs:
  build-apk:
    name: ðŸ—ï¸ Fix Config & Build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. Code Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java 17 (Required for your code)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # ðŸ› ï¸ STEP 4: THE FIX (Config Injection)
      # Ye step wo file banayega jo MISSING thi.
      # ========================================================
      - name: ðŸ”§ Generate gradle.properties
        run: |
          echo "Generating configuration file..."
          
          # 1. Enable AndroidX (Jo Error maang raha tha)
          echo "android.useAndroidX=true" > gradle.properties
          
          # 2. Enable Jetifier (Purani libs ko naye me badalne ke liye)
          echo "android.enableJetifier=true" >> gradle.properties
          
          # 3. Memory Settings (Crash rokne ke liye)
          echo "org.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=512m" >> gradle.properties
          
          # 4. Kotlin Style
          echo "kotlin.code.style=official" >> gradle.properties
          
          echo "âœ… Configuration Fixed:"
          cat gradle.properties

      # ========================================================
      # ðŸš€ STEP 5: BUILD APK
      # Ab ye fail nahi hona chahiye
      # ========================================================
      - name: ðŸš€ Build Debug APK
        id: buildCmd
        run: |
          echo "ðŸš€ Building APK..."
          # '--no-daemon' memory bachata hai
          gradle assembleDebug --no-daemon --stacktrace --console=plain

      # ========================================================
      # ðŸ“¦ STEP 6: UPLOAD ARTIFACT
      # ========================================================
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: vault-receiver-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 3
