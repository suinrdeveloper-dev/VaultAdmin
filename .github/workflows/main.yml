name: üïµÔ∏è Forensic Log Extractor

on: [push, workflow_dispatch]

jobs:
  forensic-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========================================================
      # üöÄ STEP: RUN & CAPTURE
      # Hum 'assembleDebug' chala rahe hain taki Manifest errors bhi pakad me aayein.
      # Output ko 'full_log.txt' me save kar rahe hain.
      # ========================================================
      - name: üöÄ Run Build & Capture
        run: |
          echo "Running Forensic Build..."
          # Error aane par bhi script nahi rukegi (|| true)
          gradle assembleDebug --no-daemon --stacktrace --console=plain > full_log.txt 2>&1 || true

      # ========================================================
      # üîç STEP: EXTRACT THE REAL ERROR
      # Ye step log file ke andar ghus kar sirf 'FAILURE' wala hissa nikalega.
      # ========================================================
      - name: üõë SHOW ME THE REAL REASON
        run: |
          echo "=================================================="
          echo "üîç EXTRACTED FAILURE LOG (Head of the Snake)"
          echo "=================================================="
          
          # Strategy 1: "What went wrong" dhundo
          if grep -q "What went wrong:" full_log.txt; then
             # 'What went wrong' milne par uske niche ki 30 lines dikhao
             grep -A 30 "What went wrong:" full_log.txt
          
          # Strategy 2: Agar wo nahi mila, to "FAILURE:" dhundo
          elif grep -q "FAILURE:" full_log.txt; then
             # FAILURE se pehle ki 10 aur baad ki 50 lines dikhao
             grep -B 10 -A 50 "FAILURE:" full_log.txt
          
          # Strategy 3: Kotlin error
          elif grep -q "e: " full_log.txt; then
             grep -E "e: .*kt: " full_log.txt
          
          else
             echo "‚ö†Ô∏è Could not auto-extract. Printing last 100 lines..."
             tail -n 100 full_log.txt
          fi
          
          echo "=================================================="
